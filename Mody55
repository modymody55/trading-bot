import time
import hmac
import hashlib
import requests
import json
from urllib.parse import urlencode

API_KEY = 'Ø¶Ø¹_Ù…ÙØªØ§Ø­_API_Ù‡Ù†Ø§'
API_SECRET = 'Ø¶Ø¹_SECRET_Ù‡Ù†Ø§'

BASE_URL = 'https://testnet.binance.vision'
SYMBOL = 'BTCUSDT'
TRADE_QUANTITY = 0.001
TAKE_PROFIT = 0.02
STOP_LOSS = 0.01

def get_server_time():
    return int(time.time() * 1000)

def sign_request(params):
    query_string = urlencode(params)
    signature = hmac.new(API_SECRET.encode(), query_string.encode(), hashlib.sha256).hexdigest()
    params['signature'] = signature
    return params

def send_signed_request(method, endpoint, params=None):
    if params is None:
        params = {}
    params['timestamp'] = get_server_time()
    signed_params = sign_request(params)
    headers = {'X-MBX-APIKEY': API_KEY}
    url = f"{BASE_URL}{endpoint}"
    if method == 'POST':
        response = requests.post(url, headers=headers, params=signed_params)
    elif method == 'GET':
        response = requests.get(url, headers=headers, params=signed_params)
    elif method == 'DELETE':
        response = requests.delete(url, headers=headers, params=signed_params)
    return response.json()

def get_klines():
    url = f"{BASE_URL}/api/v3/klines"
    params = {'symbol': SYMBOL, 'interval': '1m', 'limit': 15}
    response = requests.get(url, params=params)
    return response.json()

def calculate_indicators():
    klines = get_klines()
    closes = [float(k[4]) for k in klines]
    ema5 = sum(closes[-5:]) / 5
    ema15 = sum(closes[-15:]) / 15
    rsi = 50
    macd = ema5 - ema15
    return rsi, ema5, ema15, macd, closes[-1]

def place_order(side):
    params = {
        'symbol': SYMBOL,
        'side': side,
        'type': 'MARKET',
        'quantity': TRADE_QUANTITY
    }
    return send_signed_request('POST', '/api/v3/order', params)

def run_bot():
    in_position = False
    entry_price = 0.0
    while True:
        try:
            rsi, ema5, ema15, macd, current_price = calculate_indicators()
            print(f"ğŸ“Š RSI: {rsi:.2f} | EMA5: {ema5:.2f} | EMA15: {ema15:.2f} | MACD: {macd:.4f}")

            if not in_position and ema5 > ema15 and macd > 0:
                print("ğŸš€ Ø¥Ø´Ø§Ø±Ø© BUY Ù…Ø¤ÙƒØ¯Ø© â€“ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†")
                result = place_order('BUY')
                print("âœ… ØµÙÙ‚Ø© BUY ØªÙ…Øª:", result)
                entry_price = current_price
                in_position = True

            elif in_position:
                change = (current_price - entry_price) / entry_price
                print(f"ğŸ” Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙÙ‚Ø©... | Ø§Ù„Ø¯Ø®ÙˆÙ„: {entry_price} | Ø§Ù„Ø¢Ù†: {current_price} | Ù†Ø³Ø¨Ø©: {change*100:.2f}%")
                if change >= TAKE_PROFIT:
                    print("ğŸŸ¢ Ø§Ù„Ù‡Ø¯Ù ØªØ­Ù‚Ù‚ â€“ ØºÙ„Ù‚ Ø§Ù„ØµÙÙ‚Ø©")
                    result = place_order('SELL')
                    print("âœ… ØµÙÙ‚Ø© SELL ØªÙ…Øª:", result)
                    in_position = False
                elif change <= -STOP_LOSS:
                    print("ğŸ”´ ÙˆÙ‚Ù Ø®Ø³Ø§Ø±Ø© â€“ ØºÙ„Ù‚ Ø§Ù„ØµÙÙ‚Ø©")
                    result = place_order('SELL')
                    print("âœ… ØµÙÙ‚Ø© SELL ØªÙ…Øª:", result)
                    in_position = False

            time.sleep(15)

        except Exception as e:
            print("âŒ Ø®Ø·Ø£:", e)
            time.sleep(10)

if __name__ == '__main__':
    run_bot()
